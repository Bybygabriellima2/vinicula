<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reconhecimento de Objetos</title>
    <!-- Bibliotecas corrigidas do TensorFlow.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tensorflow/3.18.0/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd@2.2.2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex;
            flex-direction: column;
            align-items: center;
            color: #fff;
        }
        
        .container {
            width: 100%;
            max-width: 500px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        h1 {
            margin: 20px 0;
            font-size: 24px;
            font-weight: 600;
            text-align: center;
        }
        
        .camera-container {
            position: relative;
            width: 100%;
            max-width: 500px;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }
        
        #video {
            width: 100%;
            height: auto;
            display: block;
        }
        
        #canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        
        .controls {
            width: 100%;
            margin: 20px 0;
            display: flex;
            justify-content: center;
            gap: 10px;
        }
        
        button {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 50px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }
        
        button:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        button.active {
            background: #fff;
            color: #764ba2;
        }
        
        .stats {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 15px;
            width: 100%;
            margin-top: 20px;
            backdrop-filter: blur(10px);
        }
        
        .stats h2 {
            font-size: 18px;
            margin-bottom: 10px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }
        
        .stat-item {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 10px;
            text-align: center;
        }
        
        .stat-item h3 {
            font-size: 14px;
            margin-bottom: 5px;
            opacity: 0.8;
        }
        
        .stat-item p {
            font-size: 18px;
            font-weight: 600;
        }
        
        #loading {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            color: white;
            flex-direction: column;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .header {
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 20px;
            background: rgba(0, 0, 0, 0.2);
            margin-bottom: 20px;
            border-radius: 12px;
        }
        
        .logo {
            font-weight: bold;
            font-size: 20px;
        }

        .detected-item {
            display: flex;
            justify-content: space-between;
            background: rgba(255, 255, 255, 0.1);
            padding: 8px 15px;
            border-radius: 8px;
            margin-bottom: 8px;
        }
        
        .recent-detections {
            width: 100%;
            margin-top: 20px;
        }
        
        .detection-list {
            max-height: 200px;
            overflow-y: auto;
        }
        
        #no-camera {
            display: none;
            padding: 40px 20px;
            text-align: center;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            margin-top: 40px;
        }
        
        #error-message {
            color: #ff6b6b;
            background: rgba(0, 0, 0, 0.5);
            padding: 10px;
            border-radius: 8px;
            margin-top: 10px;
            display: none;
            text-align: center;
            width: 100%;
        }

        .model-info {
            margin-top: 10px;
            font-size: 14px;
            opacity: 0.8;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo">Visão AI</div>
            <div id="status">Carregando...</div>
        </div>
        
        <div class="camera-container">
            <video id="video" autoplay muted playsinline></video>
            <canvas id="canvas"></canvas>
        </div>
        
        <div id="error-message"></div>
        
        <div class="controls">
            <button id="startBtn" class="active">Iniciar</button>
            <button id="pauseBtn">Pausar</button>
            <button id="captureBtn">Capturar</button>
        </div>
        
        <div class="stats">
            <h2>Estatísticas</h2>
            <div class="stats-grid">
                <div class="stat-item">
                    <h3>Pessoas</h3>
                    <p id="personCount">0</p>
                </div>
                <div class="stat-item">
                    <h3>Objetos</h3>
                    <p id="objectCount">0</p>
                </div>
                <div class="stat-item">
                    <h3>Frutas</h3>
                    <p id="fruitCount">0</p>
                </div>
                <div class="stat-item">
                    <h3>Total</h3>
                    <p id="totalCount">0</p>
                </div>
            </div>
        </div>
        
        <div class="recent-detections">
            <h2>Detecções Recentes</h2>
            <div id="detectionList" class="detection-list"></div>
        </div>
        
        <p class="model-info">Utilizando COCO-SSD para detecção de objetos</p>
    </div>
    
    <div id="no-camera">
        <h2>Acesso à câmera necessário</h2>
        <p>Para usar este aplicativo, você precisa permitir o acesso à câmera do dispositivo.</p>
        <button id="retryCamera" style="margin-top: 20px;">Tentar novamente</button>
    </div>
    
    <div id="loading">
        <div class="spinner"></div>
        <p id="loading-text">Carregando modelo de IA...</p>
    </div>
    
    <script>
        // Elementos do DOM
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const startBtn = document.getElementById('startBtn');
        const pauseBtn = document.getElementById('pauseBtn');
        const captureBtn = document.getElementById('captureBtn');
        const personCount = document.getElementById('personCount');
        const objectCount = document.getElementById('objectCount');
        const fruitCount = document.getElementById('fruitCount');
        const totalCount = document.getElementById('totalCount');
        const status = document.getElementById('status');
        const detectionList = document.getElementById('detectionList');
        const loading = document.getElementById('loading');
        const loadingText = document.getElementById('loading-text');
        const noCamera = document.getElementById('no-camera');
        const retryCamera = document.getElementById('retryCamera');
        const errorMessage = document.getElementById('error-message');
        
        // Categorias em português
        const categories = {
            'person': 'Pessoa',
            'bicycle': 'Bicicleta',
            'car': 'Carro',
            'motorcycle': 'Motocicleta',
            'airplane': 'Avião',
            'bus': 'Ônibus',
            'train': 'Trem',
            'truck': 'Caminhão',
            'boat': 'Barco',
            'traffic light': 'Semáforo',
            'fire hydrant': 'Hidrante',
            'stop sign': 'Placa de Pare',
            'parking meter': 'Parquímetro',
            'bench': 'Banco',
            'bird': 'Pássaro',
            'cat': 'Gato',
            'dog': 'Cachorro',
            'horse': 'Cavalo',
            'sheep': 'Ovelha',
            'cow': 'Vaca',
            'elephant': 'Elefante',
            'bear': 'Urso',
            'zebra': 'Zebra',
            'giraffe': 'Girafa',
            'backpack': 'Mochila',
            'umbrella': 'Guarda-chuva',
            'handbag': 'Bolsa',
            'tie': 'Gravata',
            'suitcase': 'Mala',
            'frisbee': 'Frisbee',
            'skis': 'Esquis',
            'snowboard': 'Snowboard',
            'sports ball': 'Bola',
            'kite': 'Pipa',
            'baseball bat': 'Taco de Baseball',
            'baseball glove': 'Luva de Baseball',
            'skateboard': 'Skate',
            'surfboard': 'Prancha de Surf',
            'tennis racket': 'Raquete de Tênis',
            'bottle': 'Garrafa',
            'wine glass': 'Taça de Vinho',
            'cup': 'Xícara',
            'fork': 'Garfo',
            'knife': 'Faca',
            'spoon': 'Colher',
            'bowl': 'Tigela',
            'banana': 'Banana',
            'apple': 'Maçã',
            'sandwich': 'Sanduíche',
            'orange': 'Laranja',
            'broccoli': 'Brócolis',
            'carrot': 'Cenoura',
            'hot dog': 'Cachorro-quente',
            'pizza': 'Pizza',
            'donut': 'Rosquinha',
            'cake': 'Bolo',
            'chair': 'Cadeira',
            'couch': 'Sofá',
            'potted plant': 'Planta',
            'bed': 'Cama',
            'dining table': 'Mesa de Jantar',
            'toilet': 'Vaso Sanitário',
            'tv': 'TV',
            'laptop': 'Laptop',
            'mouse': 'Mouse',
            'remote': 'Controle Remoto',
            'keyboard': 'Teclado',
            'cell phone': 'Celular',
            'microwave': 'Micro-ondas',
            'oven': 'Forno',
            'toaster': 'Torradeira',
            'sink': 'Pia',
            'refrigerator': 'Geladeira',
            'book': 'Livro',
            'clock': 'Relógio',
            'vase': 'Vaso',
            'scissors': 'Tesoura',
            'teddy bear': 'Ursinho de Pelúcia',
            'hair drier': 'Secador de Cabelo',
            'toothbrush': 'Escova de Dentes'
        };
        
        // Identificar frutas para estatísticas
        const fruits = ['banana', 'apple', 'orange'];
        
        // Estado da aplicação
        let model;
        let isRunning = false;
        let videoStream;
        let animationId;
        let stats = {
            person: 0,
            objects: 0,
            fruits: 0,
            total: 0
        };
        let detectionHistory = [];
        
        // Inicializar a aplicação
        async function init() {
            try {
                loadingText.textContent = "Verificando TensorFlow.js...";
                
                // Verificar se TensorFlow.js está carregado
                if (typeof tf === 'undefined') {
                    throw new Error("TensorFlow.js não foi carregado corretamente.");
                }
                
                loadingText.textContent = "Carregando modelo COCO-SSD...";
                
                // Verificar se o modelo COCO-SSD está disponível
                if (typeof cocoSsd === 'undefined') {
                    throw new Error("Modelo COCO-SSD não foi carregado corretamente.");
                }
                
                // Carregar o modelo com tratamento de erro aprimorado
                await loadModel();
                
            } catch (error) {
                console.error("Erro na inicialização:", error);
                handleInitError(error);
            }
        }
        
        // Tratar erros de inicialização
        function handleInitError(error) {
            loading.innerHTML = `
                <p>Erro ao carregar recursos: ${error.message}</p>
                <p>Por favor, verifique sua conexão com a internet.</p>
                <button onclick="location.reload()" style="margin-top: 20px">Tentar novamente</button>
            `;
        }
        
        // Carregar o modelo
        async function loadModel() {
            try {
                // Forçar download do modelo para garantir que ele esteja disponível
                model = await cocoSsd.load({
                    base: 'lite_mobilenet_v2'  // Modelo mais leve e rápido
                });
                
                loading.style.display = 'none';
                status.textContent = 'Modelo Carregado';
                startCamera();
            } catch (error) {
                console.error('Erro ao carregar modelo:', error);
                loadingText.textContent = `Erro ao carregar o modelo: ${error.message}`;
                
                // Tentar usar um modelo alternativo se o primeiro falhar
                try {
                    loadingText.textContent = "Tentando modelo alternativo...";
                    model = await cocoSsd.load();
                    loading.style.display = 'none';
                    status.textContent = 'Modelo Carregado';
                    startCamera();
                } catch (secondError) {
                    loading.innerHTML = `
                        <p>Não foi possível carregar o modelo de IA</p>
                        <p>Erro: ${secondError.message}</p>
                        <button onclick="location.reload()" style="margin-top: 20px">Tentar novamente</button>
                    `;
                }
            }
        }
        
        // Iniciar a câmera
        async function startCamera() {
            try {
                const constraints = {
                    video: {
                        facingMode: 'environment',
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    }
                };
                
                errorMessage.style.display = 'none';
                status.textContent = 'Acessando câmera...';
                
                videoStream = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = videoStream;
                
                video.onloadedmetadata = () => {
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    startDetection();
                };
            } catch (error) {
                console.error('Erro ao acessar câmera:', error);
                noCamera.style.display = 'block';
                status.textContent = 'Sem acesso à câmera';
                errorMessage.textContent = `Erro: ${error.message}`;
                errorMessage.style.display = 'block';
            }
        }
        
        // Iniciar detecção
        function startDetection() {
            if (!isRunning) {
                isRunning = true;
                startBtn.classList.add('active');
                pauseBtn.classList.remove('active');
                status.textContent = 'Detectando...';
                detectFrame();
            }
        }
        
        // Pausar detecção
        function pauseDetection() {
            if (isRunning) {
                isRunning = false;
                startBtn.classList.remove('active');
                pauseBtn.classList.add('active');
                status.textContent = 'Pausado';
                cancelAnimationFrame(animationId);
            }
        }
        
        // Capturar imagem atual
        function captureImage() {
            if (videoStream) {
                // Criar um canvas temporário para a captura
                const captureCanvas = document.createElement('canvas');
                captureCanvas.width = video.videoWidth;
                captureCanvas.height = video.videoHeight;
                const captureContext = captureCanvas.getContext('2d');
                
                // Desenhar o frame atual do vídeo
                captureContext.drawImage(video, 0, 0, captureCanvas.width, captureCanvas.height);
                
                // Converter para imagem e baixar
                const image = captureCanvas.toDataURL('image/png');
                const link = document.createElement('a');
                link.href = image;
                link.download = `deteccao-${new Date().toISOString().slice(0,19).replace(/:/g,'-')}.png`;
                link.click();
                
                status.textContent = 'Imagem capturada';
                setTimeout(() => {
                    if (isRunning) {
                        status.textContent = 'Detectando...';
                    } else {
                        status.textContent = 'Pausado';
                    }
                }, 2000);
            }
        }
        
        // Detectar objetos em um frame
        async function detectFrame() {
            if (isRunning) {
                try {
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                    
                    const predictions = await model.detect(video);
                    
                    // Resetar contagens temporárias
                    let tempStats = {
                        person: 0,
                        objects: 0,
                        fruits: 0,
                        total: 0
                    };
                    
                    // Processar cada detecção
                    predictions.forEach((prediction) => {
                        const [x, y, width, height] = prediction.bbox;
                        const classname = prediction.class;
                        
                        // Traduzir classe
                        const translatedClass = categories[classname] || classname;
                        
                        // Atualizar estatísticas
                        tempStats.total++;
                        if (classname === 'person') {
                            tempStats.person++;
                        } else if (fruits.includes(classname)) {
                            tempStats.fruits++;
                        } else {
                            tempStats.objects++;
                        }
                        
                        // Estilizar caixa delimitadora
                        ctx.strokeStyle = '#4CAF50';
                        ctx.lineWidth = 4;
                        ctx.strokeRect(x, y, width, height);
                        
                        // Fundo da etiqueta
                        ctx.fillStyle = 'rgba(0, 0, 0, 0.6)';
                        ctx.fillRect(x, y - 30, width, 30);
                        
                        // Texto da etiqueta
                        ctx.fillStyle = 'white';
                        ctx.font = '18px Arial';
                        ctx.fillText(`${translatedClass} ${(prediction.score * 100).toFixed(1)}%`, x + 5, y - 8);
                        
                        // Adicionar à história de detecções se for uma nova
                        const existingDetection = detectionHistory.findIndex(item => item.class === classname);
                        if (existingDetection === -1) {
                            detectionHistory.unshift({
                                class: classname,
                                translatedClass: translatedClass,
                                time: new Date().toLocaleTimeString()
                            });
                            
                            // Manter histórico com no máximo 10 detecções
                            if (detectionHistory.length > 10) {
                                detectionHistory.pop();
                            }
                            
                            // Atualizar a lista de detecções
                            updateDetectionList();
                        }
                    });
                    
                    // Atualizar estatísticas
                    stats = tempStats;
                    updateStats();
                    
                    // Se não houver erros, limpar mensagem de erro
                    errorMessage.style.display = 'none';
                    
                } catch (error) {
                    console.error('Erro na detecção:', error);
                    errorMessage.textContent = `Erro na detecção: ${error.message}`;
                    errorMessage.style.display = 'block';
                    
                    // Pausar detecção se ocorrer um erro persistente
                    if (error.message.includes('model')) {
                        pauseDetection();
                        status.textContent = 'Erro no modelo';
                    }
                }
                
                // Continuar o loop de detecção
                if (isRunning) {
                    animationId = requestAnimationFrame(detectFrame);
                }
            }
        }
        
        // Atualizar as estatísticas na interface
        function updateStats() {
            personCount.textContent = stats.person;
            objectCount.textContent = stats.objects;
            fruitCount.textContent = stats.fruits;
            totalCount.textContent = stats.total;
        }
        
        // Atualizar a lista de detecções
        function updateDetectionList() {
            detectionList.innerHTML = '';
            detectionHistory.forEach(item => {
                const div = document.createElement('div');
                div.className = 'detected-item';
                div.innerHTML = `
                    <span>${item.translatedClass}</span>
                    <span>${item.time}</span>
                `;
                detectionList.appendChild(div);
            });
        }
        
        // Limpar recursos quando sair da página
        window.addEventListener('beforeunload', () => {
            if (videoStream) {
                videoStream.getTracks().forEach(track => track.stop());
            }
            if (animationId) {
                cancelAnimationFrame(animationId);
            }
        });
        
        // Event listeners
        startBtn.addEventListener('click', startDetection);
        pauseBtn.addEventListener('click', pauseDetection);
        captureBtn.addEventListener('click', captureImage);
        retryCamera.addEventListener('click', () => {
            noCamera.style.display = 'none';
            startCamera();
        });
        
        // Inicializar a aplicação
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>